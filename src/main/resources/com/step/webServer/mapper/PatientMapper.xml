<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.step.webServer.mapper.PatientMapper">
    <cache-ref namespace="com.step.webServer.mapper" />
    <select id="numPatientsByUsername" resultType="java.lang.Integer">
      select count(distinct patient.patient_id)
      from user, patient
      where user.team_id = patient.team_id
        and user.username = #{username}
    </select>
    <select id="numNewPatientsByUsername" resultType="java.lang.Integer">
      select count(distinct patient.patient_id)
      from user, patient
      where user.team_id = patient.team_id
        and user.username = #{username}
      and patient.create_datetime > DATE_SUB(NOW(), INTERVAL 1 MONTH)
    </select>
    <sql id="bpTarget">
        select B.create_date, B.patient_id, sbp_target, dbp_target
        from (select max(create_date) as create_date, patient_id
              from followup group by patient_id) as A,
             followup as B
        where A.patient_id = B.patient_id and A.create_date = B.create_date
    </sql>
    <select id="numPatientsWithInvalidBpByUsername" resultType="java.lang.Integer">
        select count(distinct bprecord.patient_id) from bprecord,
                                                        (<include refid="bpTarget"/>) as C,
                                                        user,
                                                        patient
        where bprecord.create_datetime > C.create_date
        and bprecord.patient_id = C.patient_id
        and (bprecord.dbp > C.dbp_target
               or
             bprecord.sbp > C.sbp_target)
        and bprecord.patient_id = patient.patient_id
        and patient.team_id = user.team_id
        and user.username = #{username}
    </select>
    <select id="numNewPatientsNotTestedByUsername" resultType="java.lang.Integer">
        select count(distinct patient.patient_id)
        from user left join patient on user.team_id = patient.team_id
        where user.username = #{username}
        and patient.create_datetime > DATE_SUB(NOW(), INTERVAL 1 MONTH)
        and not exists(select bprecord_id from bprecord
                        where bprecord.create_datetime > DATE_SUB(NOW(), INTERVAL 3 DAY )
                        and patient.patient_id = bprecord.patient_id)
    </select>
    <sql id="latestHomeBp">
        select bprecord.patient_id, concat(sbp, '/', dbp) as latest_home_bp
        from bprecord inner join (select max(create_datetime) as max_datetime, patient_id
                                  from bprecord
                                  group by patient_id) as latest_bprecord
        on create_datetime = max_datetime and
          bprecord.patient_id = latest_bprecord.patient_id
    </sql>
    <select id="selectAllPatients" resultType="map">
        select patient.patient_id, patient_name, patient.gender, patient.age, latest_home_bp
        from patient
          inner join user using (team_id)
          left join (<include refid="latestHomeBp"/>) as A using (patient_id)
        where user.username = #{username}
          <if test="keyword != null and keyword != ''">
              and (
              patient_name like concat('%', #{keyword}, '%')
              or patient.phone_no like concat('%', #{keyword}, '%')
              or patient.prc_id like concat('%',#{keyword}, '%')
              )
          </if>
    </select>
    <select id="selectPatientId" resultType="int">
        select patient_id from patient
        where patient_name = #{patientName}
    </select>
    <insert id="insertPatient">
        insert into patient
          (patient_name, create_datetime, gender, prc_id, birthday,
           marriage, ethnicity, degree_education, profession, address,
           phone_no, medical_insurance_type_id, emerg_cont_name,
           emerg_cont_phone_no, emerg_cont_relationship, team_id, age)
           values (#{patientName}, #{createDatetime}, #{gender}, #{prcId}, #{birthday},
                   #{marriage}, #{ethnicity}, #{degreeEducation}, #{profession}, #{address},
                   #{phoneNo}, #{medicalInsuranceTypeId}, #{emergContName},
                   #{emergContPhoneNo}, #{emergContRelationship}, #{teamId}, #{age}
                   )
    </insert>

</mapper>
